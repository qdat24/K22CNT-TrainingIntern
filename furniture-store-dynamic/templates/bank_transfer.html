{% extends "base.html" %}

{% block title %}Chuyển Khoản - Nội Thất Sang Trọng{% endblock %}

{% block content %}
<!-- Page Header -->
<section style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 40px 0; text-align: center;">
    <div class="container">
        <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">
            <i class="fas fa-university"></i> Thanh Toán Chuyển Khoản
        </h1>
        <p>Quét mã QR hoặc chuyển khoản thủ công</p>
    </div>
</section>

<!-- Bank Transfer Section -->
<section class="cart-section">
    <div class="container">
        <div style="max-width: 900px; margin: 0 auto;">
            
            <!-- Countdown Timer -->
            <div style="background: #fff3cd; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; text-align: center; border: 2px solid #ffc107;">
                <div style="color: #856404; font-size: 1.1rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-clock"></i> Thời gian còn lại để thanh toán:
                </div>
                <div id="countdown" style="font-size: 2.5rem; font-weight: bold; color: #e67e22; font-family: 'Courier New', monospace;">
                    15:00
                </div>
                <div style="color: #856404; font-size: 0.9rem; margin-top: 0.5rem;">
                    Vui lòng hoàn tất thanh toán trong thời gian trên
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                
                <!-- QR Code -->
                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
                    <h2 style="color: #2c3e50; margin-bottom: 1.5rem;">
                        <i class="fas fa-qrcode"></i> Quét Mã QR
                    </h2>
                    
                    <div style="background: white; padding: 1rem; border: 3px solid #3498db; border-radius: 10px; display: inline-block; margin-bottom: 1rem;">
                        <!-- VietQR Code -->
                        <img src="https://img.vietqr.io/image/{{ bank_code }}-{{ account_number }}-compact2.jpg?amount={{ total }}&addInfo={{ order_id }}&accountName={{ account_name | urlencode }}" 
                             alt="QR Code" 
                             style="width: 280px; height: 280px; display: block;">
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 1rem; border-radius: 5px; margin-top: 1rem;">
                        <div style="color: #1976d2; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-mobile-alt"></i> Cách quét:
                        </div>
                        <div style="color: #555; font-size: 0.9rem; text-align: left;">
                            1. Mở app ngân hàng<br>
                            2. Chọn "Quét mã QR"<br>
                            3. Quét mã QR phía trên<br>
                            4. Xác nhận thanh toán
                        </div>
                    </div>
                </div>
                
                <!-- Bank Info -->
                <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h2 style="color: #2c3e50; margin-bottom: 1.5rem;">
                        <i class="fas fa-info-circle"></i> Thông Tin Chuyển Khoản
                    </h2>
                    
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 5px; margin-bottom: 1rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.3rem;">Ngân hàng</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #2c3e50;">
                                <img src="https://api.vietqr.io/img/{{ bank_code }}.png" 
                                     style="height: 24px; vertical-align: middle; margin-right: 0.5rem;" 
                                     onerror="this.style.display='none'">
                                {{ bank_name }}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.3rem;">Số tài khoản</div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div id="accountNumber" style="font-size: 1.5rem; font-weight: bold; color: #e67e22; font-family: 'Courier New', monospace;">
                                    {{ account_number }}
                                </div>
                                <button onclick="copyToClipboard('{{ account_number }}', 'Đã copy số tài khoản!')" 
                                        style="padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.3rem;">Chủ tài khoản</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: #2c3e50;">
                                {{ account_name }}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.3rem;">Số tiền</div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div id="amount" style="font-size: 1.8rem; font-weight: bold; color: #27ae60;">
                                    {{ total | format_currency }}
                                </div>
                                <button onclick="copyToClipboard('{{ total }}', 'Đã copy số tiền!')" 
                                        style="padding: 0.5rem 1rem; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 0;">
                            <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.3rem;">
                                Nội dung chuyển khoản 
                                <span style="color: #e74c3c; font-weight: bold;">*</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div id="transferContent" style="font-size: 1.2rem; font-weight: bold; color: #e67e22; font-family: 'Courier New', monospace;">
                                    {{ order_id }}
                                </div>
                                <button onclick="copyToClipboard('{{ order_id }}', 'Đã copy nội dung!')" 
                                        style="padding: 0.5rem 1rem; background: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <div style="color: #e74c3c; font-size: 0.85rem; margin-top: 0.5rem; font-weight: 600;">
                                ⚠️ Vui lòng nhập ĐÚNG nội dung để đơn hàng được xử lý tự động
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #d4edda; padding: 1rem; border-radius: 5px; border-left: 4px solid #28a745;">
                        <div style="color: #155724; font-size: 0.9rem;">
                            <i class="fas fa-check-circle"></i> <strong>Lưu ý:</strong><br>
                            • Đơn hàng sẽ được xử lý tự động sau khi nhận được thanh toán<br>
                            • Thời gian xử lý: 1-5 phút<br>
                            • Nếu quá 15 phút không thanh toán, đơn hàng sẽ tự động hủy
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Order Info -->
            <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 2rem;">
                <h3 style="color: #2c3e50; margin-bottom: 1rem;">
                    <i class="fas fa-shopping-bag"></i> Thông Tin Đơn Hàng
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; color: #555;">
                    <div>
                        <strong>Mã đơn hàng:</strong> {{ order_id }}
                    </div>
                    <div>
                        <strong>Người nhận:</strong> {{ order.customer_name }}
                    </div>
                    <div>
                        <strong>Số điện thoại:</strong> {{ order.phone }}
                    </div>
                    <div>
                        <strong>Email:</strong> {{ order.email }}
                    </div>
                    <div style="grid-column: 1 / -1;">
                        <strong>Địa chỉ:</strong> {{ order.address }}
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: center;">
                <button onclick="checkPaymentStatus()" class="btn" style="padding: 15px 30px;">
                    <i class="fas fa-sync-alt"></i> Kiểm Tra Thanh Toán
                </button>
                <a href="/" class="btn" style="padding: 15px 30px; background: #6c757d;">
                    <i class="fas fa-home"></i> Về Trang Chủ
                </a>
            </div>
            
        </div>
    </div>
</section>

<script>
// Countdown timer
let timeLeft = 15 * 60; // 15 minutes
const countdownElement = document.getElementById('countdown');

function updateCountdown() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 0) {
        alert('Hết thời gian thanh toán! Đơn hàng sẽ bị hủy.');
        window.location.href = '/';
    } else if (timeLeft <= 60) {
        countdownElement.style.color = '#e74c3c';
    } else if (timeLeft <= 300) {
        countdownElement.style.color = '#f39c12';
    }
    
    timeLeft--;
}

setInterval(updateCountdown, 1000);

// Copy to clipboard
function copyToClipboard(text, message) {
    navigator.clipboard.writeText(text).then(() => {
        showToast(message || 'Đã copy!', 'success');
    }).catch(err => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast(message || 'Đã copy!', 'success');
    });
}

// Check payment status
async function checkPaymentStatus() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang kiểm tra...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/check-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                order_id: '{{ order_id }}'
            })
        });
        
        const result = await response.json();
        
        if (result.paid) {
            showToast('Thanh toán thành công!', 'success');
            setTimeout(() => {
                window.location.href = '/order-success?order_id={{ order_id }}';
            }, 1000);
        } else {
            showToast('Chưa nhận được thanh toán. Vui lòng thử lại sau!', 'error');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Có lỗi xảy ra!', 'error');
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Toast notification
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Auto refresh status every 10 seconds
setInterval(() => {
    fetch('/api/check-payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            order_id: '{{ order_id }}',
            auto: true
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.paid) {
            showToast('Đã nhận được thanh toán! Đang chuyển hướng...', 'success');
            setTimeout(() => {
                window.location.href = '/order-success?order_id={{ order_id }}';
            }, 2000);
        }
    })
    .catch(error => console.error('Auto check error:', error));
}, 10000); // Check every 10 seconds
</script>

{% endblock %}
