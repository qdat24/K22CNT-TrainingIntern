{% extends "base.html" %}

{% block title %}B·ªô S∆∞u T·∫≠p N·ªôi Th·∫•t - HOMESTEAD{% endblock %}

{% block content %}
<!-- Products Hero -->
<section class="hero-modern" style="padding: 4rem 0;">
    <div class="container">
        <h1>B·ªô S∆∞u T·∫≠p N·ªôi Th·∫•t</h1>
        <p>Kh√°m ph√° kh√¥ng gian s·ªëng ·∫•m √°p v·ªõi n·ªôi th·∫•t ch·∫•t l∆∞·ª£ng cao</p>
        <div class="hero-buttons" style="margin-top: 2rem;">
            <a href="#products" class="btn btn-lg">
                <i class="fas fa-arrow-down"></i>
                Xem S·∫£n Ph·∫©m
            </a>
            <a href="/categories" class="btn btn-lg btn-white">
                <i class="fas fa-th"></i>
                Danh M·ª•c
            </a>
        </div>
    </div>
</section>

<!-- Search & Filter Section -->
<section class="search-section">
    <div class="container">
        <div class="search-wrapper">
            <!-- Search Box -->
            <div class="search-box-new">
                <i class="fas fa-search"></i>
                <input type="text" 
                       placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." 
                       value="{{ search }}"
                       id="searchInput"
                       onkeypress="if(event.key === 'Enter') performSearch()">
            </div>
            
            <!-- Sort Select -->
            <select class="filter-select-new" onchange="sortProducts(this.value)">
                <option value="">S·∫Øp x·∫øp theo</option>
                <option value="price_asc">Gi√°: Th·∫•p ƒë·∫øn Cao</option>
                <option value="price_desc">Gi√°: Cao ƒë·∫øn Th·∫•p</option>
                <option value="name_asc">T√™n: A-Z</option>
                <option value="rating_desc">ƒê√°nh gi√° cao nh·∫•t</option>
                <option value="newest">M·ªõi nh·∫•t</option>
            </select>
        </div>
    </div>
</section>

<!-- Category Filter Tabs -->
<section class="categories-filter-section" style="padding: 2rem 0; background: white; border-bottom: 1px solid var(--border-color);">
    <div class="container">
        <div class="category-tabs-wrapper" style="display: flex; gap: 0.75rem; overflow-x: auto; padding: 0.5rem 0;">
            <button class="category-tab {% if not selected_category %}active{% endif %}" 
                    onclick="filterByCategory('')"
                    style="padding: 0.875rem 1.75rem; border-radius: var(--radius-full); background: {% if not selected_category %}var(--gradient-sage){% else %}white{% endif %}; color: {% if not selected_category %}white{% else %}var(--text-dark){% endif %}; border: 2px solid {% if not selected_category %}transparent{% else %}var(--border-color){% endif %}; font-weight: 600; cursor: pointer; transition: all var(--transition-normal); white-space: nowrap; flex-shrink: 0;">
                <i class="fas fa-th"></i> T·∫•t C·∫£
            </button>
            {% for category in categories %}
            <button class="category-tab {% if selected_category == category %}active{% endif %}" 
                    onclick="filterByCategory('{{ category }}')"
                    style="padding: 0.875rem 1.75rem; border-radius: var(--radius-full); background: {% if selected_category == category %}var(--gradient-sage){% else %}white{% endif %}; color: {% if selected_category == category %}white{% else %}var(--text-dark){% endif %}; border: 2px solid {% if selected_category == category %}transparent{% else %}var(--border-color){% endif %}; font-weight: 600; cursor: pointer; transition: all var(--transition-normal); white-space: nowrap; flex-shrink: 0;">
                <i class="fas fa-tag"></i> {{ category }}
            </button>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Products Section -->
<section id="products" class="products-enhanced">
    <div class="container">
        <!-- Results Info -->
        {% if products %}
        <div class="results-info" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2.5rem; padding-bottom: 1.5rem; border-bottom: 2px solid var(--border-color);">
            <div>
                <p style="font-size: 1.125rem; color: var(--text-medium); margin: 0;">
                    T√¨m th·∫•y <strong style="color: var(--sage-medium); font-size: 1.375rem;">{{ products | length }}</strong> s·∫£n ph·∫©m
                    {% if search %}
                    <span style="font-size: 0.9375rem; color: var(--text-light);">
                        cho "<strong>{{ search }}</strong>"
                    </span>
                    {% endif %}
                    {% if selected_category %}
                    <span style="display: inline-block; padding: 0.375rem 0.875rem; background: var(--sage-light); color: var(--sage-dark); border-radius: var(--radius-full); font-size: 0.875rem; font-weight: 700; margin-left: 0.5rem;">
                        {{ selected_category }}
                    </span>
                    {% endif %}
                </p>
            </div>
            {% if search or selected_category %}
            <a href="/products" class="btn btn-sm btn-outline" style="border: 2px solid var(--sage-medium); color: var(--sage-medium);">
                <i class="fas fa-times"></i>
                X√≥a B·ªô L·ªçc
            </a>
            {% endif %}
        </div>

        <!-- Products Grid -->
        <div class="products-grid-new" id="productsGrid">
            {% for product in products %}
            <div class="product-new" data-aos="fade-up" data-aos-delay="{{ loop.index0 * 50 }}" onclick="window.location.href='/product/{{ product.id }}'">
                <div class="prod-img-wrap">
                    <img src="{{ product.image }}" alt="{{ product.name }}" loading="lazy">
                    {% if product.original_price > product.price %}
                    <span class="disc-badge">
                        -{{ ((product.original_price - product.price) / product.original_price * 100) | int }}%
                    </span>
                    {% endif %}
                    <!-- Quick View Overlay -->
                    <div class="quick-view-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(45, 39, 31, 0.8); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity var(--transition-normal); pointer-events: none;">
                        <button class="btn btn-sm" onclick="event.stopPropagation(); quickView({{ product.id }})" style="pointer-events: all;">
                            <i class="fas fa-eye"></i> Xem Nhanh
                        </button>
                    </div>
                </div>
                <div class="prod-details">
                    <span class="prod-cat">{{ product.category }}</span>
                    <h3 class="prod-name">{{ product.name }}</h3>
                    <div class="prod-rating">
                        {% for i in range(5) %}
                            {% if i < product.rating %}
                                <i class="fas fa-star"></i>
                            {% else %}
                                <i class="far fa-star"></i>
                            {% endif %}
                        {% endfor %}
                        <span class="review-cnt">({{ product.reviews }})</span>
                    </div>
                    <div class="prod-price-new">
                        <span class="price-current">{{ product.price | format_currency }}</span>
                        {% if product.original_price > product.price %}
                        <span class="price-old">{{ product.original_price | format_currency }}</span>
                        {% endif %}
                    </div>
                    <button class="btn btn-sm" onclick="event.stopPropagation(); addToCart({{ product.id }})" style="width: 100%;">
                        <i class="fas fa-shopping-cart"></i> Th√™m V√†o Gi·ªè
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination (if needed) -->
        {% if total_pages is defined and total_pages > 1 %}
        <div class="pagination" style="margin-top: 4rem;">
            {% if page is defined and page > 1 %}
            <a href="?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">
                <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
            </a>
            {% endif %}
            
            {% for p in range(1, total_pages + 1) %}
                {% if page is defined and p == page %}
                <a class="active">{{ p }}</a>
                {% else %}
                <a href="?page={{ p }}{% if search %}&search={{ search }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">{{ p }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page is defined and page < total_pages %}
            <a href="?page={{ page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">
                Sau <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="empty-cart" style="margin-top: 3rem;">
            <div class="empty-cart-icon">
                <i class="fas fa-search"></i>
            </div>
            <h2>Kh√¥ng T√¨m Th·∫•y S·∫£n Ph·∫©m</h2>
            <p>
                {% if search %}
                Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o cho "<strong>{{ search }}</strong>"
                {% elif selected_category %}
                Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o trong danh m·ª•c "<strong>{{ selected_category }}</strong>"
                {% else %}
                Hi·ªán t·∫°i ch∆∞a c√≥ s·∫£n ph·∫©m n√†o
                {% endif %}
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <a href="/products" class="btn btn-lg">
                    <i class="fas fa-home"></i>
                    Xem T·∫•t C·∫£
                </a>
                <button class="btn btn-lg btn-outline" onclick="clearFilters()">
                    <i class="fas fa-redo"></i>
                    Th·ª≠ L·∫°i
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Featured Categories CTA -->
{% if products %}
<section class="promo-section">
    <div class="container">
        <div class="section-head">
            <h2>Kh√°m Ph√° Th√™m</h2>
            <p>C√°c danh m·ª•c n·ªôi th·∫•t ph·ªï bi·∫øn</p>
        </div>
        <div class="promo-grid-new">
            <div class="promo-box">
                <h3>üõãÔ∏è Ph√≤ng Kh√°ch</h3>
                <p>Sofa, b√†n tr√†, k·ªá tivi hi·ªán ƒë·∫°i</p>
                <a href="/products?category=Ph√≤ng Kh√°ch" class="btn btn-white">Xem Ngay</a>
            </div>
            <div class="promo-box warm">
                <h3>üõèÔ∏è Ph√≤ng Ng·ªß</h3>
                <p>Gi∆∞·ªùng, t·ªß qu·∫ßn √°o, b√†n trang ƒëi·ªÉm</p>
                <a href="/products?category=Ph√≤ng Ng·ªß" class="btn btn-white">Xem Ngay</a>
            </div>
            <div class="promo-box wood">
                <h3>üçΩÔ∏è Ph√≤ng ƒÇn</h3>
                <p>B√†n ƒÉn, gh·∫ø ƒÉn, t·ªß b·∫øp cao c·∫•p</p>
                <a href="/products?category=Ph√≤ng ƒÇn" class="btn btn-white">Xem Ngay</a>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Custom Styles for Category Tabs -->
<style>
    /* Category Tab Hover Effects */
    .category-tab:hover {
        background: var(--gradient-sage) !important;
        color: white !important;
        border-color: transparent !important;
        transform: translateY(-3px);
        box-shadow: var(--shadow-sage);
    }

    .category-tab.active {
        background: var(--gradient-sage) !important;
        color: white !important;
        box-shadow: var(--shadow-sage);
    }

    /* Quick View Overlay */
    .product-new:hover .quick-view-overlay {
        opacity: 1 !important;
    }

    /* Category Tabs Scrollbar */
    .category-tabs-wrapper::-webkit-scrollbar {
        height: 6px;
    }

    .category-tabs-wrapper::-webkit-scrollbar-track {
        background: var(--bg-beige);
        border-radius: var(--radius-full);
    }

    .category-tabs-wrapper::-webkit-scrollbar-thumb {
        background: var(--sage-medium);
        border-radius: var(--radius-full);
    }

    .category-tabs-wrapper::-webkit-scrollbar-thumb:hover {
        background: var(--sage-dark);
    }

    /* Loading Animation */
    .products-grid-new.loading {
        opacity: 0.5;
        pointer-events: none;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .product-new {
        animation: fadeInUp 0.6s ease-out;
        animation-fill-mode: both;
    }

    /* Stagger animation for products */
    {% for i in range(20) %}
    .product-new:nth-child({{ i + 1 }}) {
        animation-delay: {{ i * 0.1 }}s;
    }
    {% endfor %}

    /* Empty State Icon Animation */
    .empty-cart-icon i {
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 0.3;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.5;
        }
    }

    /* Dark Mode Adjustments */
    body.dark-mode .category-tab:not(.active) {
        background: var(--dark-bg-card) !important;
        color: var(--dark-text-primary) !important;
        border-color: var(--dark-border) !important;
    }

    body.dark-mode .category-tab:not(.active):hover {
        background: linear-gradient(135deg, var(--dark-sage), var(--dark-sage-dark)) !important;
        color: white !important;
    }

    body.dark-mode .categories-filter-section {
        background: var(--dark-bg-secondary) !important;
        border-bottom: 1px solid var(--dark-border) !important;
    }

    body.dark-mode .results-info {
        border-bottom-color: var(--dark-border) !important;
    }

    body.dark-mode .results-info p strong {
        color: var(--dark-sage-light) !important;
    }
</style>

<!-- JavaScript Functions -->
<script>
    // Search Function
    function performSearch() {
        const searchValue = document.getElementById('searchInput').value;
        const currentCategory = '{{ selected_category }}';
        let url = '/products?search=' + encodeURIComponent(searchValue);
        if (currentCategory) {
            url += '&category=' + encodeURIComponent(currentCategory);
        }
        window.location.href = url;
    }

    // Filter by Category
    function filterByCategory(category) {
        const currentSearch = '{{ search }}';
        let url = '/products';
        if (category) {
            url += '?category=' + encodeURIComponent(category);
        }
        if (currentSearch && category) {
            url += '&search=' + encodeURIComponent(currentSearch);
        } else if (currentSearch) {
            url += '?search=' + encodeURIComponent(currentSearch);
        }
        window.location.href = url;
    }

    // Sort Products
    function sortProducts(sortValue) {
        if (!sortValue) return;
        
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('sort', sortValue);
        window.location.href = currentUrl.toString();
    }

    // Clear Filters
    function clearFilters() {
        window.location.href = '/products';
    }

    // Add to Cart with Animation
    function addToCart(productId) {
        // Show loading on button
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang th√™m...';
        button.disabled = true;

        // Simulate API call
        fetch(`/api/cart/add/${productId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            // Success animation
            button.innerHTML = '<i class="fas fa-check"></i> ƒê√£ th√™m!';
            button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
            
            // Update cart count
            updateCartCount();
            
            // Reset button after 2 seconds
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.style.background = '';
                button.disabled = false;
            }, 2000);

            // Show toast notification
            showToast('ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!', 'success');
        })
        .catch(error => {
            button.innerHTML = '<i class="fas fa-times"></i> L·ªói';
            button.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.style.background = '';
                button.disabled = false;
            }, 2000);

            showToast('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!', 'error');
        });
    }

    // Quick View Modal
    function quickView(productId) {
        // Implement quick view modal
        console.log('Quick view for product:', productId);
        // You can show a modal with product details here
    }

    // Update Cart Count
    function updateCartCount() {
        fetch('/api/cart/count')
            .then(response => response.json())
            .then(data => {
                const cartCount = document.querySelector('.cart-count');
                if (cartCount) {
                    cartCount.textContent = data.count;
                    cartCount.style.animation = 'pulse 0.5s ease-in-out';
                }
            });
    }

    // Toast Notification
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: ${type === 'success' ? 'linear-gradient(135deg, #9db892, #7a9c6f)' : 'linear-gradient(135deg, #e09380, #c97664)'};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            z-index: 9999;
            animation: slideInRight 0.3s ease-out;
        `;
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Smooth scroll to products
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Lazy loading images
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src || img.src;
                    img.classList.add('loaded');
                    observer.unobserve(img);
                }
            });
        });

        document.querySelectorAll('.prod-img-wrap img').forEach(img => {
            imageObserver.observe(img);
        });
    }
</script>

<!-- Toast Animation Styles -->
<style>
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>

{% endblock %}