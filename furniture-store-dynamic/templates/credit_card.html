{% extends "base.html" %}

{% block title %}Thanh Toán Thẻ - Nội Thất Sang Trọng{% endblock %}

{% block content %}
<!-- Page Header -->
<section style="background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 40px 0; text-align: center;">
    <div class="container">
        <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">
            <i class="fas fa-credit-card"></i> Thanh Toán Thẻ Tín Dụng/Ghi Nợ
        </h1>
        <p>An toàn & Bảo mật với công nghệ mã hóa SSL</p>
    </div>
</section>

<!-- Credit Card Payment Section -->
<section class="cart-section">
    <div class="container">
        <div style="max-width: 800px; margin: 0 auto;">
            
            <!-- Security Notice -->
            <div style="background: #d4edda; padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; border-left: 4px solid #28a745;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-shield-alt" style="font-size: 2rem; color: #28a745;"></i>
                    <div style="color: #155724;">
                        <strong style="font-size: 1.1rem;">Giao dịch được bảo mật</strong><br>
                        <span style="font-size: 0.9rem;">
                            Thông tin thẻ của bạn được mã hóa và bảo mật tuyệt đối. Chúng tôi không lưu trữ thông tin thẻ.
                        </span>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 380px; gap: 2rem;">
                
                <!-- Payment Form -->
                <div>
                    <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h2 style="color: #2c3e50; margin-bottom: 1.5rem;">
                            <i class="fas fa-credit-card"></i> Thông Tin Thẻ
                        </h2>
                        
                        <form id="cardPaymentForm" onsubmit="processCardPayment(event)">
                            
                            <!-- Card Number -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                    Số thẻ <span style="color: red;">*</span>
                                </label>
                                <div style="position: relative;">
                                    <input type="text" 
                                           id="cardNumber" 
                                           name="card_number" 
                                           required
                                           maxlength="19"
                                           placeholder="1234 5678 9012 3456"
                                           oninput="formatCardNumber(this)"
                                           onkeyup="detectCardType(this.value)"
                                           style="width: 100%; padding: 12px 50px 12px 12px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 1.1rem; font-family: 'Courier New', monospace;">
                                    <div id="cardType" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 1.5rem;">
                                        <i class="fas fa-credit-card" style="color: #ccc;"></i>
                                    </div>
                                </div>
                                <div id="cardError" style="color: #e74c3c; font-size: 0.85rem; margin-top: 0.3rem; display: none;">
                                    Số thẻ không hợp lệ
                                </div>
                            </div>
                            
                            <!-- Cardholder Name -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                    Tên chủ thẻ <span style="color: red;">*</span>
                                </label>
                                <input type="text" 
                                       name="card_name" 
                                       required
                                       placeholder="NGUYEN VAN A"
                                       oninput="this.value = this.value.toUpperCase()"
                                       style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 1rem; text-transform: uppercase;">
                            </div>
                            
                            <!-- Expiry & CVV -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                        Ngày hết hạn <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" 
                                           id="expiryDate"
                                           name="expiry" 
                                           required
                                           maxlength="5"
                                           placeholder="MM/YY"
                                           oninput="formatExpiry(this)"
                                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 1rem; font-family: 'Courier New', monospace;">
                                    <div id="expiryError" style="color: #e74c3c; font-size: 0.85rem; margin-top: 0.3rem; display: none;">
                                        Ngày hết hạn không hợp lệ
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                        CVV <span style="color: red;">*</span>
                                        <span style="color: #7f8c8d; font-weight: normal; font-size: 0.85rem;">
                                            <i class="fas fa-question-circle" title="3 số ở mặt sau thẻ"></i>
                                        </span>
                                    </label>
                                    <input type="text" 
                                           name="cvv" 
                                           required
                                           maxlength="4"
                                           placeholder="123"
                                           oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 1rem; font-family: 'Courier New', monospace;">
                                </div>
                            </div>
                            
                            <!-- Save Card Option -->
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" name="save_card" style="width: 18px; height: 18px; margin-right: 0.5rem;">
                                    <span>Lưu thẻ này cho lần thanh toán sau</span>
                                </label>
                            </div>
                            
                            <!-- Submit Button -->
                            <button type="submit" class="btn" style="width: 100%; padding: 15px; font-size: 1.1rem;">
                                <i class="fas fa-lock"></i> Thanh Toán {{ total | format_currency }}
                            </button>
                            
                            <div style="text-align: center; margin-top: 1rem; color: #7f8c8d; font-size: 0.9rem;">
                                <i class="fas fa-lock"></i> Được bảo mật bởi SSL 256-bit
                            </div>
                            
                        </form>
                    </div>
                    
                    <!-- Accepted Cards -->
                    <div style="background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 1.5rem;">
                        <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">Chấp nhận thanh toán:</div>
                        <div style="display: flex; gap: 1rem; font-size: 2rem; align-items: center;">
                            <i class="fab fa-cc-visa" style="color: #1A1F71;"></i>
                            <i class="fab fa-cc-mastercard" style="color: #EB001B;"></i>
                            <i class="fab fa-cc-amex" style="color: #006FCF;"></i>
                            <i class="fab fa-cc-jcb" style="color: #0066B2;"></i>
                            <span style="color: #7f8c8d; font-size: 0.9rem;">và nhiều loại khác</span>
                        </div>
                    </div>
                </div>
                
                <!-- Order Summary -->
                <div style="position: sticky; top: 100px;">
                    <div style="background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="color: #2c3e50; margin-bottom: 1rem;">
                            <i class="fas fa-shopping-bag"></i> Đơn Hàng
                        </h3>
                        
                        <div style="max-height: 200px; overflow-y: auto; margin-bottom: 1rem;">
                            {% for item in order['items'] %}
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e0e0e0;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 0.9rem;">{{ item.name }}</div>
                                    <div style="color: #7f8c8d; font-size: 0.85rem;">SL: {{ item.quantity }}</div>
                                </div>
                                <div style="font-weight: 600; color: #e67e22;">
                                    {{ item.subtotal | format_currency }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div style="border-top: 2px solid #e0e0e0; padding-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Tạm tính:</span>
                                <span>{{ order.subtotal | format_currency }}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <span>Phí vận chuyển:</span>
                                <span>
                                    {% if order.shipping_fee == 0 %}
                                    <span style="color: #27ae60; font-weight: bold;">Miễn phí</span>
                                    {% else %}
                                    {{ order.shipping_fee | format_currency }}
                                    {% endif %}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-top: 1rem; border-top: 2px solid #2c3e50;">
                                <span style="font-size: 1.2rem; font-weight: bold;">Tổng cộng:</span>
                                <span style="font-size: 1.5rem; font-weight: bold; color: #e67e22;">
                                    {{ total | format_currency }}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Info -->
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-top: 1rem; font-size: 0.9rem;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50;">Thông tin khách hàng:</div>
                        <div style="color: #555;">
                            <div style="margin-bottom: 0.3rem;">{{ order.customer_name }}</div>
                            <div style="margin-bottom: 0.3rem;">{{ order.phone }}</div>
                            <div>{{ order.email }}</div>
                        </div>
                    </div>
                </div>
                
            </div>
            
        </div>
    </div>
</section>

<script>
// Format card number
function formatCardNumber(input) {
    let value = input.value.replace(/\s/g, '');
    let formattedValue = value.replace(/(.{4})/g, '$1 ').trim();
    input.value = formattedValue;
}

// Detect card type
function detectCardType(number) {
    const cardType = document.getElementById('cardType');
    const cleanNumber = number.replace(/\s/g, '');
    
    if (/^4/.test(cleanNumber)) {
        cardType.innerHTML = '<i class="fab fa-cc-visa" style="color: #1A1F71;"></i>';
    } else if (/^5[1-5]/.test(cleanNumber)) {
        cardType.innerHTML = '<i class="fab fa-cc-mastercard" style="color: #EB001B;"></i>';
    } else if (/^3[47]/.test(cleanNumber)) {
        cardType.innerHTML = '<i class="fab fa-cc-amex" style="color: #006FCF;"></i>';
    } else if (/^35/.test(cleanNumber)) {
        cardType.innerHTML = '<i class="fab fa-cc-jcb" style="color: #0066B2;"></i>';
    } else {
        cardType.innerHTML = '<i class="fas fa-credit-card" style="color: #ccc;"></i>';
    }
}

// Format expiry date
function formatExpiry(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2, 4);
    }
    input.value = value;
}

// Validate card using Luhn algorithm
function validateCardNumber(number) {
    const cleanNumber = number.replace(/\s/g, '');
    if (!/^\d{13,19}$/.test(cleanNumber)) return false;
    
    let sum = 0;
    let isEven = false;
    
    for (let i = cleanNumber.length - 1; i >= 0; i--) {
        let digit = parseInt(cleanNumber[i]);
        
        if (isEven) {
            digit *= 2;
            if (digit > 9) digit -= 9;
        }
        
        sum += digit;
        isEven = !isEven;
    }
    
    return sum % 10 === 0;
}

// Validate expiry date
function validateExpiry(expiry) {
    const match = expiry.match(/^(\d{2})\/(\d{2})$/);
    if (!match) return false;
    
    const month = parseInt(match[1]);
    const year = parseInt('20' + match[2]);
    
    if (month < 1 || month > 12) return false;
    
    const now = new Date();
    const expiryDate = new Date(year, month - 1);
    
    return expiryDate > now;
}

// Process card payment
async function processCardPayment(event) {
    event.preventDefault();
    
    const form = event.target;
    const cardNumber = form.card_number.value;
    const expiry = form.expiry.value;
    const cardError = document.getElementById('cardError');
    const expiryError = document.getElementById('expiryError');
    
    // Reset errors
    cardError.style.display = 'none';
    expiryError.style.display = 'none';
    
    // Validate card number
    if (!validateCardNumber(cardNumber)) {
        cardError.style.display = 'block';
        return;
    }
    
    // Validate expiry
    if (!validateExpiry(expiry)) {
        expiryError.style.display = 'block';
        return;
    }
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý thanh toán...';
    submitBtn.disabled = true;
    
    // Simulate payment processing (2-3 seconds)
    setTimeout(async () => {
        try {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            data.order_id = '{{ order_id }}';
            data.amount = {{ total }};
            
            const response = await fetch('/api/process-card-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Thanh toán thành công!', 'success');
                setTimeout(() => {
                    window.location.href = '/order-success?order_id={{ order_id }}';
                }, 1000);
            } else {
                showToast('Thanh toán thất bại: ' + (result.message || 'Vui lòng thử lại'), 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Có lỗi xảy ra! Vui lòng thử lại.', 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }, 2000);
}

// Toast notification
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>

{% endblock %}
