{% extends "base.html" %}
{% block title %}Đăng Ký - Nội Thất ABC{% endblock %}

{# Nếu base.html dùng block khác cho CSS/JS, đổi tên 'head'/'scripts' tương ứng #}
{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    /* ===== Reset nhẹ để chống xung đột CSS cũ ===== */
    .auth-container *, .auth-container *::before, .auth-container *::after { box-sizing: border-box; }
    .auth-container h1, .auth-container h2, .auth-container h3,
    .auth-container p { margin: 0; }

    /* ===== Layout ===== */
    .auth-container{
      min-height: calc(100vh - 120px);
      display:grid; place-items:center;
      padding: clamp(20px, 3.2vw, 48px);
      background: #f6f8fb;
    }
    .auth-box{
      width:min(720px, 100%);
      background:#fff;
      border:1px solid rgba(2,6,23,.06);
      border-radius:16px;
      box-shadow:0 12px 28px rgba(2,6,23,.08);
      padding: clamp(24px, 3vw, 40px);
    }

    /* ===== Heading ===== */
    .auth-title{
      display:flex; align-items:center; gap:12px;
      font-weight:800; font-size: clamp(22px, 2.6vw, 28px);
      color:#1f2a37; letter-spacing:.2px;
      margin-bottom:6px;
    }
    .auth-sub{ color:#6b7280; margin-bottom:18px; }

    /* ===== Alerts (flash) ===== */
    .alert{ display:flex; gap:10px; align-items:flex-start; padding:12px 14px;
      border-radius:12px; margin:10px 0 16px; border:1px solid transparent; font-weight:600; }
    .alert i{ margin-top:2px }
    .alert-success{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0 }
    .alert-danger{  background:#fef2f2; color:#7f1d1d; border-color:#fecaca }
    .alert-warning{ background:#fffbeb; color:#7c2d12; border-color:#fde68a }
    .alert-info{    background:#eff6ff; color:#1e3a8a; border-color:#bfdbfe }

    /* ===== Form ===== */
    form{ margin-top:6px }
    .form-group{ margin-bottom:16px; }
    .form-group label{
      display:block; font-weight:700; color:#1f2a37;
      margin-bottom:8px; letter-spacing:.2px;
    }
    .form-group label i{ color:#64748b; width:18px; margin-right:6px }
    .form-control{
      width:100%; display:block;
      padding:12px 14px;
      border-radius:12px; border:1px solid #e5e7eb; background:#fff;
      color:#111827; font:inherit; line-height:1.5;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .form-control::placeholder{ color:#9ca3af }
    .form-control:focus{
      outline:0; border-color:#2563eb; box-shadow:0 0 0 4px rgba(37,99,235,.15);
    }
    textarea.form-control{ resize:vertical; min-height:96px }

    /* 2 cột đẹp trên màn rộng */
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:16px }
    @media (max-width: 720px){ .grid-2{ grid-template-columns:1fr } }

    /* Help & error text */
    .help{ font-size:.9rem; color:#6b7280; margin-top:6px }
    .error{ font-size:.9rem; color:#dc2626; margin-top:6px; display:none }

    /* Password meter (đơn giản, không chiếm chỗ) */
    .pw-meter{ display:flex; gap:6px; margin-top:8px }
    .pw-bar{ height:8px; flex:1; border-radius:999px; background:#e5e7eb }
    .pw-bar.active-1{ background:#fca5a5 }
    .pw-bar.active-2{ background:#fdba74 }
    .pw-bar.active-3{ background:#86efac }
    .pw-bar.active-4{ background:#22c55e }

    /* Toggle eye đặt trong dòng input bằng position relative của wrapper */
    .input-wrap{ position:relative }
    .btn-eye{
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      border:0; background:transparent; color:#64748b; cursor:pointer; padding:6px 8px;
    }

    /* Button submit */
    .btn{
      width:100%; display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:14px 16px; border-radius:12px; border:1px solid transparent;
      font-weight:800; letter-spacing:.2px; cursor:pointer;
      color:#fff; background:#16a34a;
      box-shadow:0 12px 24px rgba(22,163,74,.18);
      transition: filter .15s ease, transform .08s ease;
    }
    .btn:hover{ filter:brightness(.96) }
    .btn:active{ transform: translateY(0) }

    /* Links */
    .auth-links{ margin-top:18px; text-align:center; color:#6b7280 }
    .auth-links a{ color:#2563eb; font-weight:700; text-decoration:none }
    .auth-links a:hover{ text-decoration:underline }

    /* Dark mode hệ thống */
    @media (prefers-color-scheme: dark){
      .auth-container{ background:#0b1220 }
      .auth-box{ background:#0f172a; border-color:#1f2937 }
      .auth-title{ color:#e5e7eb } .auth-sub{ color:#94a3b8 }
      .form-group label{ color:#e5e7eb }
      .form-control{ background:#0b1220; border-color:#1f2937; color:#e5e7eb }
      .form-control::placeholder{ color:#64748b }
      .help{ color:#94a3b8 } .auth-links{ color:#94a3b8 }
      .auth-links a{ color:#93c5fd }
    }
  </style>
{% endblock %}

{% block content %}
<div class="auth-container">
  <div class="auth-box">
    <h2 class="auth-title"><i class="fa-solid fa-user-plus"></i> Đăng Ký Tài Khoản</h2>
    <p class="auth-sub">Tạo tài khoản để theo dõi đơn hàng, lưu sổ địa chỉ & nhận ưu đãi sớm nhất.</p>

    {# Flash messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">
            <i class="fas fa-{{ 'check-circle' if category == 'success' else ('exclamation-triangle' if category == 'warning' else ('circle-info' if category == 'info' else 'exclamation-circle')) }}"></i>
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('customer_register') }}" novalidate>
      <div class="form-group">
        <label for="full_name"><i class="fas fa-user"></i> Họ và tên <span style="color:#dc2626">*</span></label>
        <input class="form-control" type="text" id="full_name" name="full_name" required placeholder="Nhập họ và tên">
        <div class="error" id="err_full_name">Vui lòng nhập họ và tên.</div>
      </div>

      <div class="grid-2">
        <div class="form-group">
          <label for="email"><i class="fas fa-envelope"></i> Email <span style="color:#dc2626">*</span></label>
          <input class="form-control" type="email" id="email" name="email" required placeholder="Nhập email">
          <div class="error" id="err_email">Email không hợp lệ.</div>
        </div>

        <div class="form-group">
          <label for="phone"><i class="fas fa-phone"></i> Số điện thoại</label>
          <input class="form-control" type="tel" id="phone" name="phone" placeholder="Ví dụ: 09xxxxxxxx hoặc +84xxxxxxxxx">
        </div>
      </div>

      <div class="form-group">
        <label for="address"><i class="fas fa-map-marker-alt"></i> Địa chỉ</label>
        <textarea class="form-control" id="address" name="address" rows="3" placeholder="Nhập địa chỉ của bạn"></textarea>
      </div>

      <div class="grid-2">
        <div class="form-group">
          <label for="password"><i class="fas fa-lock"></i> Mật khẩu <span style="color:#dc2626">*</span></label>
          <div class="input-wrap">
            <input class="form-control" type="password" id="password" name="password" minlength="6" required placeholder="Tối thiểu 6 ký tự" autocomplete="new-password">
            <button class="btn-eye" type="button" aria-label="Hiện/ẩn mật khẩu" data-target="password"><i class="fa-regular fa-eye"></i></button>
          </div>
          <div class="pw-meter" aria-hidden="true">
            <span class="pw-bar" id="bar1"></span>
            <span class="pw-bar" id="bar2"></span>
            <span class="pw-bar" id="bar3"></span>
            <span class="pw-bar" id="bar4"></span>
          </div>
          <div class="help">Mẹo: thêm chữ hoa, số, ký tự đặc biệt để mạnh hơn.</div>
          <div class="error" id="err_password">Mật khẩu quá ngắn.</div>
        </div>

        <div class="form-group">
          <label for="confirm_password"><i class="fas fa-lock"></i> Xác nhận mật khẩu <span style="color:#dc2626">*</span></label>
          <div class="input-wrap">
            <input class="form-control" type="password" id="confirm_password" name="confirm_password" minlength="6" required placeholder="Nhập lại mật khẩu" autocomplete="new-password">
            <button class="btn-eye" type="button" aria-label="Hiện/ẩn mật khẩu" data-target="confirm_password"><i class="fa-regular fa-eye"></i></button>
          </div>
          <div class="error" id="err_confirm">Mật khẩu nhập lại chưa khớp.</div>
        </div>
      </div>

      <button type="submit" class="btn">
        <i class="fas fa-user-plus"></i> Tạo tài khoản
      </button>
    </form>

    <div class="auth-links">
      <p>Đã có tài khoản? <a href="{{ url_for('customer_login') }}">Đăng nhập ngay</a></p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // Toggle hiện/ẩn mật khẩu
    document.querySelectorAll('.btn-eye').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-target');
        const input = document.getElementById(id);
        const icon = btn.querySelector('i');
        if(input.type === 'password'){ input.type='text'; icon.classList.replace('fa-eye','fa-eye-slash'); }
        else { input.type='password'; icon.classList.replace('fa-eye-slash','fa-eye'); }
      });
    });

    // Meter đơn giản
    const pwd = document.getElementById('password');
    const bars = ['bar1','bar2','bar3','bar4'].map(id=>document.getElementById(id));
    function strength(p){
      let s=0; if(!p) return 0;
      if(p.length>=6) s++; if(/[A-Z]/.test(p)) s++; if(/\d/.test(p)) s++; if(/\W/.test(p)) s++;
      if(p.length>=12 && s>=3) s=4; return s;
    }
    function render(s){
      bars.forEach(b=>{ b.className='pw-bar'; });
      for(let i=0;i<s;i++){ bars[i].classList.add(`active-${s}`); }
    }
    pwd && pwd.addEventListener('input', e=>{
      const v=e.target.value; render(strength(v));
      document.getElementById('err_password').style.display = v.length>=6 ? 'none':'block';
      checkConfirm();
    });

    // Xác nhận khớp
    const confirmEl = document.getElementById('confirm_password');
    function checkConfirm(){
      const ok = confirmEl.value==='' || (pwd.value===confirmEl.value);
      document.getElementById('err_confirm').style.display = ok ? 'none':'block';
      return ok;
    }
    confirmEl && confirmEl.addEventListener('input', checkConfirm);

    // Email & Họ tên cơ bản
    const emailEl = document.getElementById('email');
    emailEl && emailEl.addEventListener('input', ()=>{
      const valid=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value);
      document.getElementById('err_email').style.display = (emailEl.value==='' || valid) ? 'none':'block';
    });
    const fullNameEl = document.getElementById('full_name');
    fullNameEl && fullNameEl.addEventListener('input', ()=>{
      document.getElementById('err_full_name').style.display = fullNameEl.value.trim()? 'none':'block';
    });

    // Chặn submit nếu lỗi
    const form=document.querySelector('.auth-box form');
    form && form.addEventListener('submit', (e)=>{
      let ok=true;
      if(!fullNameEl.value.trim()){ document.getElementById('err_full_name').style.display='block'; ok=false; }
      if(pwd.value.length<6){ document.getElementById('err_password').style.display='block'; ok=false; }
      if(!checkConfirm()) ok=false;
      const valid=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value);
      if(!valid){ document.getElementById('err_email').style.display='block'; ok=false; }
      if(!ok) e.preventDefault();
    });
  </script>
{% endblock %}
